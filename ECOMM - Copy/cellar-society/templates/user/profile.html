{% extends "user/base.html" %}

{% block title %}My Profile - Cellar Society{% endblock %}

{% block content %}
<div class="page-header">
    <h2>My Profile</h2>
    <p class="subtitle">Manage and protect your account</p>
</div>

<div class="profile-container">
    <div class="profile-sidebar">
        <div class="sidebar-section">
            <h3>My Account</h3>
            <ul class="sidebar-menu">
                <li class="active" id="profile-tab"><a href="#" onclick="showSection('profile')">Profile</a></li>
                <li id="banks-cards-tab"><a href="#" onclick="showSection('banks-cards')">Banks & Cards</a></li>
                <li id="addresses-tab"><a href="#" onclick="showSection('addresses')">Addresses</a></li>
                <li id="privacy-tab"><a href="#" onclick="showSection('privacy')">Privacy Settings</a></li>
                <li><a href="#">Notification Settings</a></li>
            </ul>
        </div>
    </div>

    <div class="profile-content">
        <!-- Profile Section -->
        <div id="profile-section" class="profile-section">
            <h3>Username</h3>
            <div class="profile-form">
                <div class="form-group">
                    <label for="name">Name</label>
                    <div class="input-with-action">
                        <input type="text" id="name" value="{{ user.name }}" readonly>
                        <span class="change-link" onclick="enableEditing('name')">Change</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <div class="input-with-action">
                        <input type="email" id="email" value="{{ user.masked_email }}" readonly>
                        <span class="change-link" onclick="enableEditing('email')">Change</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <div class="input-with-action">
                        <input type="tel" id="phone" value="{{ user.masked_phone }}" readonly>
                        <span class="change-link" onclick="enableEditing('phone')">Change</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="date_of_birth">Date of Birth</label>
                    <div class="input-with-action">
                        <input type="text" id="date_of_birth" value="{{ user.masked_dob }}" readonly>
                        <span class="change-link" onclick="enableEditing('date_of_birth')">Change</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn secondary" onclick="openPasswordModal()">Change Password</button>
                    <button type="submit" class="btn primary" id="saveBtn" onclick="saveChanges()">Save</button>
                </div>
            </div>
        </div>

        <!-- Banks & Cards Section -->
        <div id="banks-cards-section" class="profile-section hidden">
            <h3>Payment Methods</h3>

            <!-- Credit/Debit Cards Section -->
            <div class="payment-section">
                <div class="section-header">
                    <h4>Credit / Debit Card</h4>
                    <button class="btn primary btn-small" onclick="openAddCardModal()">
                        + Add New Card
                    </button>
                </div>

                <div class="cards-container">
                    <div class="empty-state">
                        <div class="empty-icon">üí≥</div>
                        <h5>You don't have cards yet</h5>
                        <p>Add your credit or debit card to make purchases easier</p>
                    </div>
                </div>
            </div>

            <!-- Bank Accounts Section -->
            <div class="payment-section">
                <div class="section-header">
                    <h4>My Bank Accounts</h4>
                    <button class="btn primary btn-small" onclick="openAddBankModal()">
                        + Add New Bank Account
                    </button>
                </div>

                <div class="cards-container">
                    <div class="empty-state">
                        <div class="empty-icon">üè¶</div>
                        <h5>You don't have bank accounts yet</h5>
                        <p>Link your bank account for seamless transactions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Addresses Section -->
        <div id="addresses-section" class="profile-section hidden">
            <h3>My Addresses</h3>

            <div class="section-header">
                <h4>Saved Addresses</h4>
                <button class="btn primary btn-small" onclick="openAddAddressModal()">
                    + Add New Address
                </button>
            </div>

            <div class="addresses-container" id="addressesContainer">
                {% if addresses %}
                {% for address in addresses %}
                <div class="address-card" data-address-id="{{ address.id }}">
                    <div class="address-header">
                        <div class="address-label">
                            <h5>{{ address.label }}</h5>
                            {% if address.is_default %}
                            <span class="default-badge">Default</span>
                            {% endif %}
                        </div>
                        <div class="address-actions">
                            {% if not address.is_default %}
                            <button class="btn-text" onclick="setDefaultAddress({{ address.id }})">Set as Default</button>
                            <button class="btn-text danger" onclick="deleteAddress({{ address.id }})">Delete</button>
                            {% else %}
                            <span class="default-text">Default Address</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="address-details">
                        <p><strong>{{ address.full_name }}</strong></p>
                        <p>{{ address.street_address }}</p>
                        <p>{{ address.city }}, {{ address.state }} {{ address.zip_code }}</p>
                        <p>{{ address.country }}</p>
                        <p class="phone-number">{{ address.phone_number }}</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üè†</div>
                    <h5>You don't have any saved addresses yet</h5>
                    <p>Add your delivery addresses for faster checkout</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Privacy Settings Section -->
        <div id="privacy-section" class="profile-section hidden">
            <h3>Privacy Settings</h3>

            <div class="privacy-section">
                <div class="section-header">
                    <h4>Account Deletion</h4>
                    <button class="btn danger" onclick="openDeleteAccountModal()">
                        Delete
                    </button>
                </div>

                <div class="privacy-content">
                    <p>Permanently delete your account and all associated data. This action cannot be undone.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Password Change Modal -->
<div id="passwordModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change Password</h3>
            <button class="close-btn" onclick="closePasswordModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="passwordForm">
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>

                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" required minlength="6">
                    <small class="password-hint">Password must be at least 6 characters long</small>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" required minlength="6">
                    <small id="password-match" class="password-hint hidden">Passwords do not match</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn secondary" onclick="closePasswordModal()">Cancel</button>
                    <button type="submit" class="btn primary">Update Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Card Modal -->
<div id="addCardModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Card</h3>
            <button class="close-btn" onclick="closeAddCardModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addCardForm">
                <div class="form-group">
                    <label for="card_number">Card Number</label>
                    <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" required
                        maxlength="19">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expiry_date">Expiry Date</label>
                        <input type="text" id="expiry_date" name="expiry_date" placeholder="MM/YY" required
                            maxlength="5">
                    </div>
                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" name="cvv" placeholder="123" required maxlength="3">
                    </div>
                </div>

                <div class="form-group">
                    <label for="card_holder">Card Holder Name</label>
                    <input type="text" id="card_holder" name="card_holder" placeholder="John Doe" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn secondary" onclick="closeAddCardModal()">Cancel</button>
                    <button type="submit" class="btn primary">Add Card</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Bank Account Modal -->
<div id="addBankModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Bank Account</h3>
            <button class="close-btn" onclick="closeAddBankModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addBankForm">
                <div class="form-group">
                    <label for="bank_name">Bank Name</label>
                    <select id="bank_name" name="bank_name" required>
                        <option value="">Select Bank</option>
                        <option value="BDO">BDO Unibank</option>
                        <option value="BPI">BPI</option>
                        <option value="Metrobank">Metrobank</option>
                        <option value="Landbank">Landbank</option>
                        <option value="PNB">PNB</option>
                        <option value="Security Bank">Security Bank</option>
                        <option value="UnionBank">UnionBank</option>
                        <option value="Chinabank">Chinabank</option>
                        <option value="RCBC">RCBC</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="account_number">Account Number</label>
                    <input type="text" id="account_number" name="account_number" placeholder="1234567890" required>
                </div>

                <div class="form-group">
                    <label for="account_name">Account Holder Name</label>
                    <input type="text" id="account_name" name="account_name" placeholder="John Doe" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn secondary" onclick="closeAddBankModal()">Cancel</button>
                    <button type="submit" class="btn primary">Add Bank Account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Address Modal -->
<div id="addAddressModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Address</h3>
            <button class="close-btn" onclick="closeAddAddressModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addAddressForm">
                <div class="form-group">
                    <label for="address_label">Address Label</label>
                    <input type="text" id="address_label" name="address_label" placeholder="Home, Work, etc." required>
                </div>

                <div class="form-group">
                    <label for="full_name">Full Name</label>
                    <input type="text" id="full_name" name="full_name" placeholder="John Doe" required>
                </div>

                <div class="form-group">
                    <label for="phone_number">Phone Number</label>
                    <input type="tel" id="phone_number" name="phone_number" placeholder="+63" required>
                </div>

                <div class="form-group">
                    <label for="street_address">Street Address</label>
                    <input type="text" id="street_address" name="street_address" placeholder="123 Main Street" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" placeholder="Manila" required>
                    </div>
                    <div class="form-group">
                        <label for="state">State/Province</label>
                        <input type="text" id="state" name="state" placeholder="Metro Manila" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="zip_code">ZIP Code</label>
                        <input type="text" id="zip_code" name="zip_code" placeholder="1000" required>
                    </div>
                    <div class="form-group">
                        <label for="country">Country</label>
                        <input type="text" id="country" name="country" value="Philippines" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-option">
                        <input type="checkbox" id="is_default" name="is_default">
                        <span class="checkbox-custom"></span>
                        Set as default address
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn secondary" onclick="closeAddAddressModal()">Cancel</button>
                    <button type="submit" class="btn primary">Add Address</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div id="deleteAccountModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Delete Account</h3>
            <button class="close-btn" onclick="closeDeleteAccountModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-section">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <h4>Are you sure you want to delete your account?</h4>
                <p class="warning-text">This action cannot be undone. All your data will be permanently removed.</p>
            </div>

            <div class="terms-section">
                <p class="terms-title">By clicking on "Proceed", you agree to the following:</p>
                <ul class="terms-list">
                    <li>Account deletion is irreversible. Upon successful deletion of your account, you will not be able
                        to log in to the deleted account and view account history.</li>
                    <li>Your account cannot be deleted if you have any pending purchases, sales and/or outstanding
                        matters including legal matters.</li>
                    <li>The deletion of your account does not discharge you from any outstanding liabilities and/or
                        obligations.</li>
                </ul>
            </div>

            <div class="form-actions">
                <button type="button" class="btn secondary" onclick="closeDeleteAccountModal()">Cancel</button>
                <button type="button" class="btn danger" onclick="openPasswordVerificationModal()">Proceed</button>
            </div>
        </div>
    </div>
</div>

<!-- Password Verification Modal -->
<div id="passwordVerificationModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Verify Your Identity</h3>
            <button class="close-btn" onclick="closePasswordVerificationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-section">
                <div class="warning-icon">üîí</div>
                <h4>Confirm Account Deletion</h4>
                <p class="warning-text">Please enter your password to permanently delete your account.</p>
            </div>

            <form id="passwordVerificationForm">
                <div class="form-group">
                    <label for="verify_password">Password</label>
                    <input type="password" id="verify_password" name="verify_password" required>
                </div>

                <div class="form-group">
                    <label for="verify_password_confirm">Confirm Password</label>
                    <input type="password" id="verify_password_confirm" name="verify_password_confirm" required>
                    <small id="password-verify-match" class="password-hint hidden">Passwords do not match</small>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn secondary"
                        onclick="closePasswordVerificationModal()">Cancel</button>
                    <button type="submit" class="btn danger">Delete Account</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .profile-container {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }

    .profile-sidebar {
        width: 280px;
        flex-shrink: 0;
    }

    .sidebar-section {
        margin-bottom: 30px;
    }

    .sidebar-section h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.3em;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(90, 42, 39, 0.1);
    }

    .sidebar-menu {
        list-style: none;
    }

    .sidebar-menu li {
        margin-bottom: 8px;
    }

    .sidebar-menu a {
        display: block;
        padding: 10px 15px;
        text-decoration: none;
        color: var(--text);
        border-radius: 8px;
        transition: all 0.2s ease;
        font-weight: 500;
        cursor: pointer;
    }

    .sidebar-menu a:hover {
        background: rgba(90, 42, 39, 0.05);
        color: var(--primary);
    }

    .sidebar-menu li.active a {
        background: rgba(90, 42, 39, 0.1);
        color: var(--primary);
        font-weight: 600;
    }

    .profile-content {
        flex: 1;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        padding: 30px;
    }

    .profile-section h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.5em;
        margin-bottom: 25px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(90, 42, 39, 0.1);
    }

    .profile-form {
        max-width: 500px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary);
    }

    .input-with-action {
        display: flex;
        align-items: center;
        border: 2px solid #e5e0da;
        border-radius: 8px;
        overflow: hidden;
        transition: border 0.2s ease;
    }

    .input-with-action:focus-within {
        border-color: var(--accent);
    }

    .input-with-action input {
        flex: 1;
        padding: 12px 16px;
        border: none;
        outline: none;
        font-family: 'Poppins', sans-serif;
        font-size: 15px;
        color: var(--text);
        background: #fff;
    }

    .input-with-action input:read-only {
        background: #f9f8f7;
        color: var(--muted);
    }

    .change-link {
        padding: 12px 16px;
        color: var(--accent);
        font-weight: 500;
        cursor: pointer;
        transition: color 0.2s ease;
        white-space: nowrap;
    }

    .change-link:hover {
        color: var(--primary);
    }

    .form-actions {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 15px;
        justify-content: flex-start;
        align-items: center;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn.primary {
        background: var(--primary);
        color: white;
    }

    .btn.primary:hover {
        background: #6a302c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(90, 42, 39, 0.3);
    }

    .btn.secondary {
        background: transparent;
        color: var(--primary);
        border: 2px solid var(--primary);
    }

    .btn.secondary:hover {
        background: rgba(90, 42, 39, 0.05);
        transform: translateY(-2px);
    }

    .btn.danger {
        background: var(--danger);
        color: white;
    }

    .btn.danger:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .btn-small {
        padding: 8px 16px;
        font-size: 14px;
    }

    /* Banks & Cards Styles */
    .payment-section {
        margin-bottom: 40px;
    }

    .payment-section:last-child {
        margin-bottom: 0;
    }

    .privacy-section {
        margin-bottom: 40px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-header h4 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.3em;
        margin: 0;
    }

    .privacy-content {
        background: #f9f8f7;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e5e0da;
    }

    .privacy-content p {
        margin: 0;
        color: var(--muted);
    }

    .cards-container,
    .addresses-container {
        background: #f9f8f7;
        border-radius: 12px;
        padding: 30px;
        border: 2px dashed #e5e0da;
    }

    .empty-state {
        text-align: center;
        color: var(--muted);
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .empty-state h5 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.2em;
        margin-bottom: 8px;
    }

    .empty-state p {
        margin: 0;
        font-size: 14px;
    }

    /* Delete Account Modal Styles */
    .warning-section {
        text-align: center;
        margin-bottom: 25px;
        padding: 20px;
        background: #fff5f5;
        border-radius: 12px;
        border: 1px solid #f8d7da;
    }

    .warning-icon {
        font-size: 48px;
        margin-bottom: 15px;
    }

    .warning-section h4 {
        color: var(--danger);
        margin-bottom: 10px;
        font-family: 'Playfair Display', serif;
    }

    .warning-text {
        color: var(--muted);
        margin: 0;
    }

    .terms-section {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e5e0da;
    }

    .terms-title {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 15px;
    }

    .terms-list {
        margin: 0;
        padding-left: 20px;
        color: var(--muted);
    }

    .terms-list li {
        margin-bottom: 10px;
        line-height: 1.5;
    }

    .terms-list li:last-child {
        margin-bottom: 0;
    }

    /* Form Styles for Modals */
    .form-row {
        display: flex;
        gap: 15px;
    }

    .form-row .form-group {
        flex: 1;
    }

    select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e0da;
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-size: 15px;
        color: var(--text);
        background: #fff;
        transition: border 0.2s ease;
    }

    select:focus {
        border-color: var(--accent);
        outline: none;
    }

    /* Checkbox Styles */
    .checkbox-option {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        padding: 8px 0;
    }

    .checkbox-option input[type="checkbox"] {
        display: none;
    }

    .checkbox-custom {
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
        position: relative;
        transition: all 0.2s ease;
    }

    .checkbox-option input[type="checkbox"]:checked+.checkbox-custom {
        border-color: var(--accent);
        background: var(--accent);
    }

    .checkbox-option input[type="checkbox"]:checked+.checkbox-custom::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }

    .modal-overlay.hidden {
        display: none;
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 25px 30px 0 30px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    .modal-header h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.5em;
        margin: 0;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        color: var(--muted);
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .close-btn:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--primary);
    }

    .modal-body {
        padding: 0 30px 30px 30px;
    }

    .modal-body .form-group {
        margin-bottom: 20px;
    }

    .modal-body input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e0da;
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-size: 15px;
        color: var(--text);
        background: #fff;
        transition: border 0.2s ease;
    }

    .modal-body input:focus {
        border-color: var(--accent);
        outline: none;
    }

    .password-hint {
        display: block;
        margin-top: 5px;
        font-size: 12px;
        color: var(--muted);
    }

    .password-hint.hidden {
        display: none;
    }

    #password-match,
    #password-verify-match {
        color: var(--danger);
    }

    .modal-body .form-actions {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 15px;
        justify-content: flex-end;
    }

    /* Address Card Styles */
    .address-card {
        background: white;
        border: 1px solid #e5e0da;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.2s ease;
    }

    .address-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .address-card:last-child {
        margin-bottom: 0;
    }

    .address-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .address-label {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .address-label h5 {
        margin: 0;
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        font-size: 1.1em;
    }

    .default-badge {
        background: var(--accent);
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .address-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-text {
        background: none;
        border: none;
        color: var(--accent);
        font-weight: 500;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        font-size: 0.9em;
    }

    .btn-text:hover {
        background: rgba(198, 166, 100, 0.1);
    }

    .btn-text.danger {
        color: var(--danger);
    }

    .btn-text.danger:hover {
        background: rgba(220, 53, 69, 0.1);
    }

    .default-text {
        color: var(--muted);
        font-size: 0.9em;
        font-style: italic;
    }

    .address-details {
        color: var(--text);
        line-height: 1.5;
    }

    .address-details p {
        margin: 5px 0;
    }

    .address-details .phone-number {
        color: var(--muted);
        font-size: 0.9em;
        margin-top: 10px;
    }

    /* Utility Classes */
    .hidden {
        display: none !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .profile-container {
            flex-direction: column;
            gap: 20px;
        }

        .profile-sidebar {
            width: 100%;
        }

        .profile-content {
            padding: 20px;
        }

        .input-with-action {
            flex-direction: column;
            align-items: stretch;
        }

        .change-link {
            padding: 8px 16px;
            text-align: center;
            border-top: 1px solid #e5e0da;
        }

        .form-actions {
            flex-direction: column;
        }

        .modal-content {
            margin: 20px;
            max-width: 95%;
        }

        .modal-header,
        .modal-body {
            padding: 20px;
        }

        .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }

        .form-row {
            flex-direction: column;
            gap: 0;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Section Management
    function showSection(sectionName) {
        // Hide all sections
        document.getElementById('profile-section').classList.add('hidden');
        document.getElementById('banks-cards-section').classList.add('hidden');
        document.getElementById('addresses-section').classList.add('hidden');
        document.getElementById('privacy-section').classList.add('hidden');

        // Remove active class from all tabs
        document.getElementById('profile-tab').classList.remove('active');
        document.getElementById('banks-cards-tab').classList.remove('active');
        document.getElementById('addresses-tab').classList.remove('active');
        document.getElementById('privacy-tab').classList.remove('active');

        // Show selected section and activate tab
        document.getElementById(sectionName + '-section').classList.remove('hidden');
        document.getElementById(sectionName + '-tab').classList.add('active');

        // Load addresses if addresses section is shown
        if (sectionName === 'addresses') {
            loadAddresses();
        }
    }

    // Field editing state
    let editingField = null;

    function enableEditing(fieldId) {
        const input = document.getElementById(fieldId);
        const changeLink = input.parentElement.querySelector('.change-link');

        if (input.hasAttribute('readonly')) {
            // Enable editing
            input.removeAttribute('readonly');
            input.focus();
            changeLink.textContent = 'Cancel';
            editingField = fieldId;

            // For specific field types
            if (fieldId === 'date_of_birth') {
                input.type = 'date';
                // Remove masking when editing
                if (input.value.includes('*')) {
                    input.value = '';
                }
            } else if (fieldId === 'email' || fieldId === 'phone') {
                // Remove masking when editing
                if (input.value.includes('*')) {
                    input.value = '';
                }
            }
        } else {
            // Cancel editing
            input.setAttribute('readonly', 'readonly');
            changeLink.textContent = 'Change';
            editingField = null;

            // Reset to original value (you might want to reload from server)
            location.reload();
        }
    }

    function saveChanges() {
        if (!editingField) {
            alert('No changes to save.');
            return;
        }

        const input = document.getElementById(editingField);
        const newValue = input.value.trim();

        // Basic validation
        if (!newValue) {
            alert('Please enter a value.');
            return;
        }

        if (editingField === 'email' && !isValidEmail(newValue)) {
            alert('Please enter a valid email address.');
            return;
        }

        if (editingField === 'phone' && !isValidPhone(newValue)) {
            alert('Please enter a valid phone number.');
            return;
        }

        // Send update to server
        fetch('/user/update_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                field: editingField,
                value: newValue
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile updated successfully!');
                    location.reload();
                } else {
                    alert('Error updating profile: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating profile.');
            });
    }

    // Password Modal Functions
    function openPasswordModal() {
        document.getElementById('passwordModal').classList.remove('hidden');
        document.body.classList.add('modal-open');
        document.getElementById('current_password').focus();
    }

    function closePasswordModal() {
        document.getElementById('passwordModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
        resetPasswordForm();
    }

    function resetPasswordForm() {
        document.getElementById('passwordForm').reset();
        document.getElementById('password-match').classList.add('hidden');
    }

    // Card Modal Functions
    function openAddCardModal() {
        document.getElementById('addCardModal').classList.remove('hidden');
        document.body.classList.add('modal-open');
        document.getElementById('card_number').focus();
    }

    function closeAddCardModal() {
        document.getElementById('addCardModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
        document.getElementById('addCardForm').reset();
    }

    // Bank Modal Functions
    function openAddBankModal() {
        document.getElementById('addBankModal').classList.remove('hidden');
        document.body.classList.add('modal-open');
        document.getElementById('bank_name').focus();
    }

    function closeAddBankModal() {
        document.getElementById('addBankModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
        document.getElementById('addBankForm').reset();
    }

    // Address Modal Functions
    function openAddAddressModal() {
        document.getElementById('addAddressModal').classList.remove('hidden');
        document.body.classList.add('modal-open');
        document.getElementById('address_label').focus();
    }

    function closeAddAddressModal() {
        document.getElementById('addAddressModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
        document.getElementById('addAddressForm').reset();
    }

    // Address Management Functions
    function loadAddresses() {
        fetch('/user/addresses')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderAddresses(data.addresses);
                }
            })
            .catch(error => {
                console.error('Error loading addresses:', error);
            });
    }

    function renderAddresses(addresses) {
        const container = document.getElementById('addressesContainer');

        if (addresses.length === 0) {
            container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üè†</div>
                <h5>You don't have any saved addresses yet</h5>
                <p>Add your delivery addresses for faster checkout</p>
            </div>
        `;
            return;
        }

        container.innerHTML = addresses.map(address => `
        <div class="address-card" data-address-id="${address.id}">
            <div class="address-header">
                <div class="address-label">
                    <h5>${address.label}</h5>
                    ${address.is_default ? '<span class="default-badge">Default</span>' : ''}
                </div>
                <div class="address-actions">
                    ${!address.is_default ?
                `<button class="btn-text" onclick="setDefaultAddress(${address.id})">Set as Default</button>
                         <button class="btn-text danger" onclick="deleteAddress(${address.id})">Delete</button>` :
                `<span class="default-text">Default Address</span>`
            }
                </div>
            </div>
            <div class="address-details">
                <p><strong>${address.full_name}</strong></p>
                <p>${address.street_address}</p>
                <p>${address.city}, ${address.state} ${address.zip_code}</p>
                <p>${address.country}</p>
                <p class="phone-number">${address.phone_number}</p>
            </div>
        </div>
    `).join('');
    }

    function setDefaultAddress(addressId) {
        fetch(`/user/addresses/${addressId}/set_default`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Default address updated successfully!');
                    loadAddresses(); // Reload addresses to reflect changes
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting default address');
            });
    }

    function deleteAddress(addressId) {
        if (!confirm('Are you sure you want to delete this address?')) {
            return;
        }

        fetch(`/user/addresses/${addressId}/delete`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Address deleted successfully!');
                    loadAddresses(); // Reload addresses to reflect changes
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting address');
            });
    }

    // Delete Account Modal Functions
    function openDeleteAccountModal() {
        document.getElementById('deleteAccountModal').classList.remove('hidden');
        document.body.classList.add('modal-open');
    }

    function closeDeleteAccountModal() {
        document.getElementById('deleteAccountModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
    }

    function openPasswordVerificationModal() {
        closeDeleteAccountModal();
        document.getElementById('passwordVerificationModal').classList.remove('hidden');
        document.body.classList.add('modal-open');
        document.getElementById('verify_password').focus();
    }

    function closePasswordVerificationModal() {
        document.getElementById('passwordVerificationModal').classList.add('hidden');
        document.body.classList.remove('modal-open');
        document.getElementById('passwordVerificationForm').reset();
        document.getElementById('password-verify-match').classList.add('hidden');
    }

    // Form validation and formatting
    document.getElementById('card_number').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ');
        e.target.value = formattedValue || value;
    });

    document.getElementById('expiry_date').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\//g, '').replace(/[^0-9]/gi, '');
        if (value.length >= 2) {
            value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
    });

    document.getElementById('cvv').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/[^0-9]/gi, '');
    });

    // Phone number formatting for address
    document.getElementById('phone_number').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('63')) {
            value = '+' + value;
        } else if (value.length > 0 && !value.startsWith('63')) {
            value = '+63' + value;
        }
        e.target.value = value;
    });

    // Password verification validation
    document.getElementById('verify_password_confirm').addEventListener('input', function () {
        const password = document.getElementById('verify_password').value;
        const confirmPassword = this.value;
        const matchElement = document.getElementById('password-verify-match');

        if (confirmPassword && password !== confirmPassword) {
            matchElement.classList.remove('hidden');
        } else {
            matchElement.classList.add('hidden');
        }
    });

    // Form submissions
    document.getElementById('addCardForm').addEventListener('submit', function (e) {
        e.preventDefault();
        // Here you would typically send the card data to your backend
        alert('Card added successfully! (This is a demo)');
        closeAddCardModal();
    });

    document.getElementById('addBankForm').addEventListener('submit', function (e) {
        e.preventDefault();
        // Here you would typically send the bank data to your backend
        alert('Bank account added successfully! (This is a demo)');
        closeAddBankModal();
    });

    document.getElementById('addAddressForm').addEventListener('submit', function (e) {
        e.preventDefault();
        
        const addressData = {
            label: document.getElementById('address_label').value,
            full_name: document.getElementById('full_name').value,
            phone_number: document.getElementById('phone_number').value,
            street_address: document.getElementById('street_address').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zip_code: document.getElementById('zip_code').value,
            country: document.getElementById('country').value,
            is_default: document.getElementById('is_default').checked
        };

        // Send address data to backend
        fetch('/user/addresses/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(addressData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Address added successfully!');
                    closeAddAddressModal();
                    loadAddresses(); // Reload addresses to show the new one
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding address');
            });
    });

    // Password validation
    document.getElementById('confirm_password').addEventListener('input', function () {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = this.value;
        const matchElement = document.getElementById('password-match');

        if (confirmPassword && newPassword !== confirmPassword) {
            matchElement.classList.remove('hidden');
        } else {
            matchElement.classList.add('hidden');
        }
    });

    // Password form submission
    document.getElementById('passwordForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;

        // Validation
        if (!currentPassword || !newPassword || !confirmPassword) {
            alert('Please fill in all fields.');
            return;
        }

        if (newPassword.length < 6) {
            alert('New password must be at least 6 characters long.');
            return;
        }

        if (newPassword !== confirmPassword) {
            alert('New passwords do not match.');
            return;
        }

        // Send password change request
        fetch('/user/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password changed successfully!');
                    closePasswordModal();
                } else {
                    alert('Error changing password: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error changing password.');
            });
    });

    // Password verification form submission
    document.getElementById('passwordVerificationForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const password = document.getElementById('verify_password').value;
        const confirmPassword = document.getElementById('verify_password_confirm').value;

        // Validation
        if (!password || !confirmPassword) {
            alert('Please fill in both password fields.');
            return;
        }

        if (password !== confirmPassword) {
            alert('Passwords do not match.');
            return;
        }

        // Send account deletion request
        fetch('/user/delete_account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                password: password
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Account deleted successfully!');
                    window.location.href = '/';
                } else {
                    alert('Error deleting account: ' + data.message);
                    closePasswordVerificationModal();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting account.');
                closePasswordVerificationModal();
            });
    });

    // Utility functions
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function isValidPhone(phone) {
        const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
        return phoneRegex.test(phone.replace(/\D/g, ''));
    }

    // Close modals when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
        });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.add('hidden');
            });
            document.body.classList.remove('modal-open');
        }
    });

    // Close editing when clicking outside
    document.addEventListener('click', function (event) {
        if (editingField && !event.target.closest('.input-with-action')) {
            const input = document.getElementById(editingField);
            const changeLink = input.parentElement.querySelector('.change-link');

            input.setAttribute('readonly', 'readonly');
            changeLink.textContent = 'Change';
            editingField = null;

            // Reset masked values
            if (input.value === '') {
                location.reload();
            }
        }
    });

    // Initialize with profile section
    document.addEventListener('DOMContentLoaded', function () {
        showSection('profile');
    });
</script>
{% endblock %}