{% extends "user/base.html" %}

{% block title %}My Cart - Cellar Society{% endblock %}

{% block content %}
<div class="page-header">
    <h2>My Cart</h2>
    <p class="subtitle">Review your items and proceed to checkout</p>
</div>

{% if cart_items %}
<div class="cart-container">
    <div class="cart-header">
        <div class="cart-column select">Select</div>
        <div class="cart-column product">Product</div>
        <div class="cart-column price">Unit Price</div>
        <div class="cart-column quantity">Quantity</div>
        <div class="cart-column total">Total Price</div>
        <div class="cart-column actions">Actions</div>
    </div>

    <div class="cart-items">
        {% for item in cart_items %}
        <div class="cart-item" data-product-id="{{ item.product_id }}">
            <div class="cart-column select">
                <input type="checkbox" class="item-checkbox" data-product-id="{{ item.product_id }}"
                    data-price="{{ item.price }}" data-quantity="{{ item.quantity }}" onchange="updateSelection()">
            </div>
            <div class="cart-column product">
                <div class="product-info">
                    <div class="product-image">
                        <img src="{{ item.image_url or '/static/default.png' }}" alt="{{ item.name }}">
                    </div>
                    <div class="product-details">
                        <h4>{{ item.name }}</h4>
                        <p class="product-type">{{ item.type }}</p>
                        <p class="stock-info">Stock: {{ item.stock }} available</p>
                    </div>
                </div>
            </div>

            <div class="cart-column price">
                <span class="unit-price">â‚±{{ "%.2f"|format(item.price) }}</span>
            </div>

            <div class="cart-column quantity">
                <div class="quantity-controls">
                    <button class="quantity-btn minus" onclick="updateQuantity({{ item.product_id }}, -1)" {% if
                        item.quantity <=1 %}disabled{% endif %}>-</button>
                    <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1"
                        max="{{ item.stock }}" onchange="updateQuantityInput({{ item.product_id }}, this)">
                    <button class="quantity-btn plus" onclick="updateQuantity({{ item.product_id }}, 1)" {% if
                        item.quantity>= item.stock %}disabled{% endif %}>+</button>
                </div>
            </div>

            <div class="cart-column total">
                <span class="total-price">â‚±{{ "%.2f"|format(item.price * item.quantity) }}</span>
            </div>

            <div class="cart-column actions">
                <button class="btn danger btn-small" onclick="removeFromCart({{ item.product_id }})">Delete</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="cart-footer">
        <div class="selection-controls">
            <label class="select-all-label">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                Select All
            </label>
            <button class="btn secondary" onclick="clearCart()">Clear Cart</button>
        </div>

        <!-- In cart.html, replace the proceedToCheckout function with a form -->
        <!-- In cart.html, replace the checkout section with this -->
        <div class="checkout-section">
            <div class="total-display">
                <span class="total-label">Subtotal:</span>
                <span class="total-amount" id="selectedTotal">â‚±0.00</span>
            </div>
            <form id="checkoutForm" action="/user/checkout" method="POST">
                <input type="hidden" name="selected_items" id="selectedItemsInput">
                <button class="btn primary" type="submit" id="checkoutBtn">Proceed to Checkout</button>
            </form>
        </div>
    </div>
</div>
{% else %}
<div class="empty-cart">
    <div class="empty-icon">ðŸ›’</div>
    <h3>Your cart is empty</h3>
    <p>Add some delicious wines to your cart and they'll appear here!</p>
    <a href="{{ url_for('user_dashboard') }}" class="btn primary">Start Shopping</a>
</div>
{% endif %}
{% endblock %}

{% block styles %}
<style>
    .cart-container {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        /* Remove the margin-bottom since we're not using fixed positioning anymore */
    }


    .cart-header {
        display: grid;
        grid-template-columns: 0.5fr 2fr 1fr 1fr 1fr 0.5fr;
        gap: 20px;
        padding: 20px 30px;
        background: rgba(90, 42, 39, 0.05);
        border-bottom: 1px solid #e5e0da;
        font-weight: 600;
        color: var(--primary);
    }

    .cart-item {
        display: grid;
        grid-template-columns: 0.5fr 2fr 1fr 1fr 1fr 0.5fr;
        gap: 20px;
        padding: 25px 30px;
        border-bottom: 1px solid #f0f0f0;
        align-items: center;
        /* Allow cart items to scroll while footer stays visible */
        max-height: 60vh;
        overflow-y: auto;
    }

    .cart-item:last-child {
        border-bottom: none;
    }

    .cart-column.select {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .cart-footer {
        padding: 25px 30px;
        background: #f9f8f7;
        border-top: 1px solid #e5e0da;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        /* Make it sticky within the cart container */
        position: sticky;
        bottom: 0;
        z-index: 10;
        background: var(--card-bg);
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    .item-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
    }

    .product-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .product-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-details h4 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        margin-bottom: 5px;
        font-size: 1.1em;
    }

    .product-type {
        color: var(--muted);
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .stock-info {
        color: var(--muted);
        font-size: 0.8em;
    }

    .unit-price,
    .total-price {
        font-weight: 600;
        color: var(--accent);
        font-size: 1.1em;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .quantity-btn {
        width: 35px;
        height: 35px;
        border: 2px solid #e5e0da;
        background: white;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .quantity-btn:hover:not(:disabled) {
        border-color: var(--accent);
        background: var(--accent);
        color: white;
    }

    .quantity-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .quantity-input {
        width: 60px;
        height: 35px;
        border: 2px solid #e5e0da;
        border-radius: 6px;
        text-align: center;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
    }

    .quantity-input:focus {
        border-color: var(--accent);
        outline: none;
    }

    .selection-controls {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .select-all-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 500;
        color: var(--primary);
    }

    .select-all-label input {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
    }

    .checkout-section {
        display: flex;
        align-items: center;
        gap: 30px;
    }

    .total-display {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 1.2em;
        font-weight: 600;
    }

    .total-label {
        color: var(--primary);
    }

    .total-amount {
        color: var(--accent);
        font-size: 1.3em;
    }

    /* Button Styles to match existing design */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        font-size: 0.95em;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn.primary {
        background: var(--primary);
        color: white;
    }

    .btn.primary:hover {
        background: #6a302c;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(90, 42, 39, 0.3);
    }

    .btn.secondary {
        background: transparent;
        color: var(--muted);
        border: 2px solid #e5e0da;
    }

    .btn.secondary:hover {
        background: #5a2a27;
        color: white;
        border-color: #5a2a27;
        transform: translateY(-2px);
    }

    .btn.danger {
        background: var(--danger);
        color: white;
        padding: 8px 16px;
        font-size: 0.85em;
    }

    .btn.danger:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .btn-small {
        padding: 8px 16px;
        font-size: 0.85em;
    }

    .empty-cart {
        text-align: center;
        padding: 60px 40px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
    }

    .empty-icon {
        font-size: 80px;
        margin-bottom: 20px;
    }

    .empty-cart h3 {
        font-family: 'Playfair Display', serif;
        color: var(--primary);
        margin-bottom: 10px;
        font-size: 1.5em;
    }

    .empty-cart p {
        color: var(--muted);
        margin-bottom: 30px;
        font-size: 1.1em;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .cart-header {
            display: none;
        }

        .cart-item {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 20px;
            text-align: center;
        }

        .product-info {
            flex-direction: column;
            text-align: center;
        }

        .cart-column {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-column::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--primary);
        }

        .cart-column.select::before {
            content: "Select";
        }

        .cart-column.product::before {
            content: "Product";
        }

        .cart-column.price::before {
            content: "Unit Price";
        }

        .cart-column.quantity::before {
            content: "Quantity";
        }

        .cart-column.total::before {
            content: "Total";
        }

        .cart-column.actions::before {
            content: "Actions";
        }

        .cart-footer {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }

        .selection-controls {
            justify-content: center;
        }

        .checkout-section {
            flex-direction: column;
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    let selectedItems = new Set();

    function updateSelection() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        let total = 0;
        selectedItems.clear();

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const productId = checkbox.dataset.productId;
                const price = parseFloat(checkbox.dataset.price);
                const quantity = parseInt(checkbox.dataset.quantity);
                selectedItems.add(productId);
                total += price * quantity;
            }
        });

        // Update select all checkbox
        const selectAll = document.getElementById('selectAll');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        const someChecked = Array.from(checkboxes).some(cb => cb.checked);

        selectAll.checked = allChecked;
        selectAll.indeterminate = someChecked && !allChecked;

        // Update total display
        document.getElementById('selectedTotal').textContent = 'â‚±' + total.toFixed(2);
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.item-checkbox');

        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });

        updateSelection();
    }

    function updateQuantity(productId, change) {
        const quantityInput = document.querySelector(`.cart-item[data-product-id="${productId}"] .quantity-input`);
        if (!quantityInput) {
            console.error('Quantity input not found for product:', productId);
            return;
        }

        let newQuantity = parseInt(quantityInput.value) + change;
        newQuantity = Math.max(1, newQuantity);
        newQuantity = Math.min(newQuantity, parseInt(quantityInput.max));

        if (newQuantity !== parseInt(quantityInput.value)) {
            quantityInput.value = newQuantity;
            updateCartQuantity(productId, newQuantity);
        }
    }

    function updateQuantityInput(productId, inputElement) {
        let newQuantity = parseInt(inputElement.value);
        if (isNaN(newQuantity) || newQuantity < 1) {
            newQuantity = 1;
        }
        newQuantity = Math.min(newQuantity, parseInt(inputElement.max));

        inputElement.value = newQuantity;
        updateCartQuantity(productId, newQuantity);
    }

    function updateCartQuantity(productId, quantity) {
        fetch('/user/update_cart_quantity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating quantity: ' + data.message);
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating quantity');
                location.reload();
            });
    }

    function removeFromCart(productId) {
        if (confirm('Are you sure you want to remove this item from your cart?')) {
            fetch('/user/remove_from_cart/' + productId, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error removing item: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error removing item');
                });
        }
    }

    function clearCart() {
        if (confirm('Are you sure you want to clear your entire cart?')) {
            fetch('/user/clear_cart', {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error clearing cart: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error clearing cart');
                });
        }
    }

    // Update the form before submission
    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
        if (selectedItems.size === 0) {
            e.preventDefault();
            alert('Please select at least one item to checkout.');
            return;
        }

        // Convert selected items to JSON and put in hidden input
        const selectedItemsArray = Array.from(selectedItems).map(id => parseInt(id));
        document.getElementById('selectedItemsInput').value = JSON.stringify(selectedItemsArray);

        // Form will now submit normally to /user/checkout
    });

    // Update the form before submission - ADD DEBUGGING
    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
        console.log("DEBUG: Checkout form submitted");

        if (selectedItems.size === 0) {
            console.log("DEBUG: No items selected, preventing submission");
            e.preventDefault();
            alert('Please select at least one item to checkout.');
            return;
        }

        // Convert selected items to JSON and put in hidden input
        const selectedItemsArray = Array.from(selectedItems).map(id => parseInt(id));
        console.log("DEBUG: Selected items:", selectedItemsArray);

        document.getElementById('selectedItemsInput').value = JSON.stringify(selectedItemsArray);
        console.log("DEBUG: Hidden input value set:", document.getElementById('selectedItemsInput').value);

        // Form will now submit normally to /user/checkout
    });

</script>
{% endblock %}